define(["Mock","Utils","PubSub","lodash"],function(a,b,c,d){"use strict";function e(a){this.data=a}function f(a){e.call(this,a)}function g(a){a.limit=0,e.call(this,a)}function h(a){this.code=a,this.validated=!1,this.used=!1}function i(a,b){h.call(this,a),this.discountPercent=b}function j(a,b){h.call(this,a),this.itemId=b}function k(a,c){var d=b.copyObject(a.getAllData()),e=c.getDiscountPercent();return a instanceof g||0===a.getPrice()?a:(d.discountPercent=d.discountPercent||0,d.discountPercent+=e,d.discountPercent>100&&(d.discountPercent=100),new f(d))}function l(){o=o.map(function(a){var c=b.getRandom(10),d=null;return 7>c?d=new e(a):9>c?(a.discountPercent=b.getRandom(50),d=new f(a)):d=new g(a),d})}function m(){return o}function n(){return p}var o=a;e.prototype={getId:function(){return this.data.id},setId:function(a){return this.data.id=a,a},getName:function(){return this.data.name},getPrice:function(){return parseInt(this.data.price,10)},getStock:function(){return this.data.limit},setStock:function(a){return this.data.limit=a,a},isInStock:function(){return this.data.limit>0},getAllData:function(){return this.data},constructor:e},f.prototype=Object.create(e.prototype),f.prototype.constructor=f,f.prototype.getDiscountPercent=function(){return this.data.discountPercent},f.prototype.getPrice=function(){var a=parseInt(this.data.price,10),b=a-this.getDiscountPercent()/100*a;return parseInt(b,10)},g.prototype=Object.create(e.prototype),g.prototype.constructor=g,h.prototype={validate:function(a){return this.validated=this.code===a,this},constructor:h},i.prototype=Object.create(h.prototype),i.prototype.constructor=i,i.prototype.getDiscountPercent=function(){return this.discountPercent},i.prototype.apply=function(){if(this.validated&&!this.used){var a=this;return o=o.map(function(b){return k(b,a)}),c.publish("couponApplied",[]),this.used=!0,!0}return!1},j.prototype=Object.create(h.prototype),j.prototype.constructor=j,j.prototype.getDiscountPercent=function(){return 100},j.prototype.getItemId=function(){return this.itemId},j.prototype.apply=function(){if(this.validated&&!this.used){var a=b.getItemById(o,this.getItemId()),d=a.getStock(),e=k(a,this);return a.isInStock()?(a.setStock(d-1),e.setId(e.getId()+"F"),e.setStock(1),o.unshift(e),c.publish("couponApplied",[]),this.used=!0,!0):(alert("Sorry, item out of stock."),!0)}return!1};var p=[new i("123",20),new j("qwe","55927eac85594c45b02c5963")];return l(),{Item:e,ItemOnSale:f,ItemOutOfStock:g,Coupon:h,CouponDiscount:i,getProducts:m,getCoupons:n}});